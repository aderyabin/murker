require 'spec_helper'

RSpec.describe Murker::Generator do
  describe '#call' do
    let(:generator) { described_class.new(interaction: interaction) }
    let(:interaction) { Murker::Interaction.new(params) }

    context 'when interaction is GET /martians.json' do
      let(:params) {
        {
          verb: 'GET',
          endpoint_path: '/martians',
          status: 200,
          body: [{"name"=>"spajic", "age"=>30, "ololo"=>"OLOLO"}]
        }
      }
      expected = {
        "openapi" => "3.0.0",
        "info" => { 'title' => "Generated by Murker", 'version' => '0.1.0' },
        "paths" => {
          "/martians" => {
            "get" => {
              "responses" => {
                "'200'" => {
                  "description" => "GET /martians -> 200",
                  "content" => {
                    "application/json" => {
                      "schema" => {
                        "type" => "array",
                        "minItems" => 1,
                        "uniqueItems" => true,
                        "items" => {
                          "type"=>"object",
                          "required" => ["name", "age", "ololo"],
                          "properties" => {
                            "name" => { "type" => "string" },
                            "age" => { "type"=>"integer" },
                            "ololo" => { "type" => "string" }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
      it { expect(generator.call).to eq expected }
    end

    context 'when interaction is GET /martians/1.json' do
      let(:params) {
        {
          verb: 'GET',
          endpoint_path: '/martians/:id',
          path_params: {"controller"=>"v1/martians", "action"=>"show", "id"=>"1"},
          status: 200,
          body: {"name"=>"spajic", "age"=>30, "ololo"=>"OLOLO"}
        }
      }
      expected = {
        "openapi" => "3.0.0",
        "info" => { 'title' => "Generated by Murker", 'version' => '0.1.0' },
        "paths" => {
          "/martians/{id}" => {
            "get" => {
              "parameters"=> [
                {
                  "in" => "path",
                  "name" => "id",
                  "description" => "id",
                  "schema" => { "type" => "integer" },
                  "required" => true,
                  "example" => "1"
                }
              ],
              "responses" => {
                "'200'" => {
                  "description" => "GET /martians/:id -> 200",
                  "content" => {
                    "application/json" => {
                      "schema" => {
                        "type" => "object",
                        "required" => ["name", "age", "ololo"],
                        "properties" => {
                          "name" => { "type" => "string" },
                          "age" => { "type" => "integer" },
                          "ololo" => { "type" => "string" }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }

      it { expect(generator.call).to eq expected }
    end
  end
end
